<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TravelTracker</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>

    <div id="registrationSection">
        <h1>Registration</h1>
        <button id="loginButton">Already have a user</button>
        Name: <input type="text" id="name"><br><br>
        Email: <input type="email" id="email"><br /><br>
        Password: <input type="password" id="pswHash"><br /><br>
        <button id="createUserButton">Create User</button>
        <button id="continueWithoutUserButton">Continue without a user</button>
        
    </div>

    <div id="loginPage" class="hidden">
        <h1>Login</h1>
        Email: <input type="text" id="loginEmail"><br><br>
        Password: <input type="password" id="loginPassword"><br><br>
        <button id="loginSubmitButton">Login</button>
    </div>

    <div id="applicationPage" class="hidden">
        <h3>Welcome, <span id="loggedInUserName">!</span></h3>
        <button id="userButton">User</button>
        <button id="backToRegistrationButton">Back to Registration</button>
        <h2>Keep track of the countries you've visited!</h2>
        <br>
        <label for="countryInput">Add country:</label>
        <input type="text" id="countryInput" placeholder="Where have you been?">
        <button onclick="addCountry()">Add</button>
        <ul id="countryList"></ul>
        <p id="visitedCount">You have visited <span id="currentCount">0</span>/<span id="totalCount">195</span> countries.</p>
        <p id="percentageVisited"></p>
    </div>

    <div id="userInfoPage" class="hidden">
        <h1>Settings</h1>
        <div id="userInfo"></div>
        Name: <input type="text" id="name"><br><br>
        Password: <input type="password" id="pswHash"><br /><br>
        Email: <input type="email" id="email"><br /><br>
        <button id="updateUser">Update user</button>
        <button id="deleteUser">Delete user</button>
        <button id="backButton">Back</button>
    </div>

    <script>
        //------------------------------------------- 
        const createUserButton = document.getElementById("createUserButton");
        const continueWithoutUserButton = document.getElementById("continueWithoutUserButton");
        const registrationSection = document.getElementById("registrationSection");
        const applicationPage = document.getElementById("applicationPage");
        const userInfoPage = document.getElementById("userInfoPage");
        const loggedInUserName = document.getElementById("loggedInUserName");
        const userButton = document.getElementById("userButton");
        const backToRegistrationButton = document.getElementById("backToRegistrationButton");
        const loginButton = document.getElementById("loginButton"); 
        const loginPage = document.getElementById("loginPage"); 
        const loginSubmitButton = document.getElementById("loginSubmitButton");

        createUserButton.onclick = async function (e) {
            const name = document.getElementById("name").value;
            const email = document.getElementById("email").value;
            const password = document.getElementById("pswHash").value;
            const user = { name, email, password };
            const response = await postTo("/user", user);

            if (response.ok) {
                sessionStorage.setItem("userName", name);
                registrationSection.classList.add("hidden");
                applicationPage.classList.remove("hidden");
                loggedInUserName.textContent = name;
            }
        }

        continueWithoutUserButton.onclick = function(){
            registrationSection.classList.add("hidden");
            applicationPage.classList.remove("hidden");
            document.getElementById("percentageVisited").classList.add("hidden");
        }

        userButton.onclick = function () {
            const userName = sessionStorage.getItem("userName");
            if (userName) {
                applicationPage.classList.add("hidden");
                userInfoPage.classList.remove("hidden");
                document.getElementById("userInfo").innerHTML = `<p>Welcome, ${userName}!</p>`;
                document.getElementById("percentageVisited").classList.remove("hidden");
            }
        }

        backToRegistrationButton.onclick = function () {
            applicationPage.classList.add("hidden");
            registrationSection.classList.remove("hidden");
            document.getElementById("percentageVisited").classList.add("hidden");
        }

        loginButton.onclick = function (){
            registrationSection.classList.add("hidden");
            loginPage.classList.remove("hidden");
        }

        loginSubmitButton.onclick = function () { 
            const loginEmail = document.getElementById("loginEmail").value;
            const loginPassword = document.getElementById("loginPassword").value;
            registrationSection.classList.add("hidden");
            loginPage.classList.add("hidden");
            applicationPage.classList.remove("hidden");
            loggedInUserName.textContent = loginUsername;
        }

        document.getElementById("backButton").addEventListener("click", function () {
            userInfoPage.classList.add("hidden");
            applicationPage.classList.remove("hidden");
            if (sessionStorage.getItem("userName")){
                document.getElementById("percentageVisited").classList.remove("hidden");
            } else {
                document.getElementById("percentageVisited").classList.add("hidden");
            }
        });

        async function postTo(url, data) {
            const header = {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(data),
            };

            const response = await fetch(url, header);
            return response;
        }
//------------------------------------------- Application
        let visitedCountries = 0;
        const totalCountries = 195;

        function addCountry() {
            const countryInput = document.getElementById("countryInput").value.trim();
            if (countryInput === "") return;

            const countryList = document.getElementById("countryList");
            const listItem = document.createElement("li");
            listItem.textContent = countryInput;

            const editLink = createLink(" Edit", () => editCountry(listItem));
            const removeLink = createLink(" Remove", () => removeCountry(listItem));

            listItem.appendChild(editLink);
            listItem.appendChild(removeLink);
            countryList.appendChild(listItem);

            visitedCountries++;
            updateVisitedCount();
            document.getElementById("countryInput").value = "";
            updateVisitedPercentage();
        }

        function createLink(text, onClickHandler) {
            const link = document.createElement("a");
            link.href = "#";
            link.textContent = text;
            link.onclick = function (event) {
                onClickHandler();
                event.preventDefault();
            };
            return link;
        }

        function updateVisitedCount() {
            document.getElementById("currentCount").textContent = visitedCountries;
            document.getElementById("totalCount").textContent = totalCountries;
        }

        function updateVisitedPercentage() {
            const percentage = (visitedCountries / totalCountries) * 100;
            if (sessionStorage.getItem("userName")){
                document.getElementById("percentageVisited").textContent = `Wow! That's ${percentage.toFixed(2)}% of the world!`;
            }
        }

        function editCountry(listItem) {
            const currentName = listItem.firstChild.textContent;
            const newName = prompt("Edit country:", currentName);
            if (newName !== null && newName !== "") {
                listItem.firstChild.textContent = newName;
            }
        }

        function removeCountry(listItem) {
            listItem.remove();
            visitedCountries--;
            updateVisitedCount();
            updateVisitedPercentage();
        }
    </script>

</body>

</html>